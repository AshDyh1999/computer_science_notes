## 0. 语法
1. `:`表示层级关系
2. `- `:表示列表项
3. `  `:两个空格表示层级关系


















## 1. 文件

### 1-1. jinja
同样是`sls`后缀的文件,可能是普通文件,也可能是模板文件
+ 定义一个模板文件,这样其他文件可以从这个模板文件里导出变量
#### 1-1-1. 区分jinja2文件和普通文件
+ 如果有`- template: jinja`,就是模板
#### 1-1-2. 使用
1. 将文件管理的文件写成模板文件,定义变量
+ 变量列表 `- defaults:`,其下一级为列表项,格式为`key: value`
+ `- defaults:`写在和source同级的位置
2. 在文件管理的文件里指明的source文件里使用变量
##### 1-1-2-1. 定义happy变量名
1. 将文件管理的文件写成模板文件,定义变量
```
cd /srv/salt/base/
sudo vim dns.sls
###############
/etc/resolv.conf:
  file.managed:
    - source: salt://files/resolv.conf
    - user: root
    - group: root
    - mode: 644
    - template: jinja
    - defaults:
      DNS_SERVER: happy
###############
```
2. 在文件管理的文件里指明的source文件里使用变量
```
cd /srv/salt/base
sudo vim files/resolv.conf
################
options timeout:2 attempts:3 rotate single-request-reopen
; generated by /usr/sbin/dhclient-script
; {{ DNS_SERVER }}
nameserver 100.100.2.136
nameserver 100.100.2.138
################
```
3. 执行配置管理
```
sudo salt '*' state.highstate
```
#### 1-1-3. 提取grains的值
模板文件下的实体文件可以使用grains里面的值
+ 格式`grains['key']`
1. 在实体文件中使用grains提取出ip地址
```
cd /srv/salt/base
sudo vim files/resolv.conf
################
options timeout:2 attempts:3 rotate single-request-reopen
; generated by /usr/sbin/dhclient-script
; {{ grains['fqdn_ip4'] }}
nameserver 100.100.2.136
nameserver 100.100.2.138
################
```
2. 测试
```
sudo salt '*' state.highstate 
```








### 1-2. top.sls
+ 一定放在base环境下
+ `top.sls`是top file,因为master配置文件里写着`state_top: top.sls`
```
环境:
  匹配minion:
    - 加载什么模块
```
#### 1-2-1. 规则
1. 匹配minion
+ 全名/通配符等
+ grain/pillar(需要在其下的列表项中指出是哪个)
2. 加载什么模块
+ 我们在环境对应目录下写的sls文件的文件名(去掉`.sls`后缀)
###### 1-2-1. top.sls的例子
```
base:
  'web:hello':
    - match: grain
    - apache
```






















## 2. 普通状态
### 2-1. 文件管理
> https://docs.saltstack.com/en/latest/ref/states/all/salt.states.file.html#module-salt.states.file
#### 2-1-1. 文件管理
```
minion端的文件名:
  file.managed:
    - source: 相对于在哪个环境,就在哪个环境里找,具体的文件名
    - 用户
    - 组
    - 权限
    
```
#### 2-1-2. 文件追加
内容不用加双引号
```
minion端的文件名:
  file.append:
    - text:
      - 内容
```
#### 2-1-3. 修改内核参数
```
net.ipv4.ip_local_port_range:
  sysctl.present:    Data failed to compile:
----------
    Detected conflicting IDs, SLS IDs need to be globally unique.
    The conflicting ID is '/etc/profile' and is found in SLS 'base:init.history' and SLS 'base:init.audit'

    - value: 10000 65000
fs.file-mas:
  sysctl.present:
    - value: 100000
```
#### 2-1-4. 包含其他sls文件
当执行包含其他sls文件的sls文件时,会依次执行里面的sls文件
+ top file只需要使用这个sls文件,就可以执行里面的所有文件
+ 该文件命名随意
+ 如果该文件在base环境下的init目录下,和`dns.sls`等同级,但include这些同级文件时,仍然要从base环境本身目录找起
```
include:
  - init.dns
  - init.history
  - init.audit
  - init.sysctl
```

### 2-2. 配置
#### 2-2-1. 在master配置文件里设置top file的目录
```
sudo vim /etc/salt/master
##############
file_roots:
  base:
    - /srv/salt/base
  test:
    - /srv/salt/test
  prod:
    - /srv/salt/prod
##############
sudo systemctl restart salt-master
sudo mkdir /srv/salt/{base,test,prod}
```
#### 2-2-2. 写基本的文件管理
```
sudo mkdir /srv/salt/base/files
cd /srv/salt/base/
sudo vim dns.sls
###############
/etc/resolv.conf:
  file.managed:
    - source: salt://files/resolv.conf
    - user: root
    - group: root
    - mode: 644
###############
sudo mv /etc/resolv.conf /srv/salt/base/files/
```
#### 2-2-3. 执行文件状态
##### 2-2-3-1. 直接执行
```
sudo salt '*' state.sls dns
```

##### 2-2-3-2. 高级状态,每次执行状态都会执行
从top file开始读,top file怎么指定状态就执行
1. 修改base环境下的`top.sls`文件
```
base:
  '*':
    - dns
```
2. 执行高级状态
```
sudo salt '*' state.highstate
```

## 3. 应用
### 3-1. 系统初始化
#### 3-1-1. base环境设置为`/srv/salt/base`目录
#### 3-1-2. 在base环境下创建1个init文件夹,专门放系统初始化的文件
结构为
```
.
|-- init
|   |-- audit.sls
|   |-- dns.sls
|   |-- files
|   |   `-- resolv.conf
|   |-- history.sls
|   `-- sysctl.sls
`-- top.sls
```
#### 3-1-3. 放置系统初始化文件
> https://github.com/orris27/orris/tree/master/linux/saltstack/example/init_example

#### 3-1-0. 问题
##### 3-1-0-1. 出现冲突的id
```
    Data failed to compile:
----------
    Detected conflicting IDs, SLS IDs need to be globally unique.
    The conflicting ID is '/etc/profile' and is found in SLS 'base:init.history' and SLS 'base:init.audit'
```
###### 3-1-0-1-1. 解决
`init/history.sls`和`init/audit.sls`都对同一个文件进行追加操作,比如说第一行都是`/etc/profile:`
+ 合并
+ 其中一个妥协
  - `init/audit.sls`换成`/etc/bashrc:`


### 3-2. 功能模块
### 3-3. 业务模块


